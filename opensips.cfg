loadmodule "auth_db.so"
loadmodule "auth.so"
loadmodule "tm.so"          # Para t_relay()
loadmodule "sl.so"          # Para send_reply()
loadmodule "pv.so"          # Para variáveis $au, $ap
loadmodule "usrloc.so"      # Para save("location")
loadmodule "registrar.so"   # Para funções relacionadas ao registro
loadmodule "domain.so"     # Para db_does_uri_exist()

route {
  if (is_method("REGISTER")) {
    if (!www_authorize("", "subscriber")) {
      www_challenge("", "0");
      exit;
    }
    save("location");
  } else if (has_totag()) {
    if (!proxy_authorize("", "subscriber")) {
      proxy_challenge("", "0");
      exit;
    }
    # db_check_from() não está disponível sem db, verifica se o usuário está registrado.
    if (!lookup("location")) {
      send_reply("403", "Forbidden");
      exit;
    }
  } else {
    # db_does_uri_exist() não está disponível sem db, use a função do módulo 'domain'.
    if (!is_uri_host_local()) {
      send_reply("404", "Not Found");
      exit;
    }
    if ($au == "teste" && $ap == "123") {
      route(RELAY);
    } else {
      send_reply("401", "Unauthorized");
      exit;
    }
  }
}

route[RELAY] {
  if (!t_relay()) {
    send_reply("500", "Server Internal Error");
  }
}
