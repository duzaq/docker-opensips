loadmodule "auth_db.so"
loadmodule "auth.so"

route {
  if (is_method("REGISTER")) {
    if (!www_authorize("", "subscriber")) {
      www_challenge("", "0");
      exit;
    }
    save("location");
  } else if (has_totag()) {
    if (!proxy_authorize("", "subscriber")) {
      proxy_challenge("", "0");
      exit;
    }
    if (!db_check_from()) {
      send_reply("403", "Forbidden");
      exit;
    }
  } else {
    if (!db_does_uri_exist()) {
      send_reply("404", "Not Found");
      exit;
    }
    if ($au == "teste" && $ap == "123") {
      route(RELAY);
    } else {
      send_reply("401", "Unauthorized");
      exit;
    }
  }
}

route[RELAY] {
  if (!t_relay()) {
    send_reply("500", "Server Internal Error");
  }
}
